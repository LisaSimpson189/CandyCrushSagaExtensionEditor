<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candy Crush Custom Level</title>
    <style>
        #dock,
#customDock,
#blurredDock {
    border-radius: 20px; /* adjust as needed */
    overflow: hidden;
}
        body {
            background: no-repeat center center fixed;
            background-size: cover;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #flashContainer {
            position: relative;
            width: 755px;
            height: 600px;
            margin: 20px 0;
            overflow: hidden;
        }

        #flash {
            top: 0;
            left: 0;
            z-index: 1;
        }

        #uploadedBackground, #blurredBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            display: none;
            object-fit: cover;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.5);
        }

        #blurredBackground {
            filter: blur(10px);
        }

        #buttonContainer {
            display: flex;
            justify-content: center;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }

        button {
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            background-color: transparent;
            margin: 5px;
            position: relative;
        }

        #dock {
            width: auto;
            height: auto;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }


        #customDock {
            width: auto;
            height: auto;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }

        #restartButton { background-image: url('restart.png'); }
        #restartButton:active { background-image: url('restart_pressed.png'); }
        #shuffleButton { background-image: url('shuffle.png'); }
        #shuffleButton:active { background-image: url('shuffle_pressed.png'); }
        #sugarDropButton { background-image: url('enable_sugardrops.png'); }
        #sugarDropButton:active { background-image: url('enable_sugardrops_pressed.png'); }
        #editorButton { background-image: url('editor.png'); }
        #editorButton:active { background-image: url('editor_pressed.png'); }
        #basiliskButton { background-image: url('get_basilisk.png'); }
        #basiliskButton:active { background-image: url('get_basilisk_pressed.png'); }
        #discordButton { background-image: url('discord.png'); }
        #discordButton:active { background-image: url('discord_pressed.png'); }
        #uploadButton { background-image: url('sitebackground.png'); }
        #uploadButton:active { background-image: url('sitebackground_pressed.png'); }

        .tooltip {
            display: none;
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid gray;
            border-radius: 5px;
            padding: 5px;
            white-space: nowrap;
            z-index: 10;
        }

        button:hover .tooltip {
            display: block;
            top: -50%;
            text-align: center;
            z-index: 10;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #popupOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2;
            transition: opacity 1s ease;
        }

        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 0px;
            z-index: 3;
            text-align: center;
            width: 450px;
            height: 175px;
            transition: transform 0.5s ease;
        }

        #popup button {
            transition: transform 0.5s ease, filter 0.2s ease;
        }

        #popup button:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        #popup button {
            margin: 10px;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border: none;
            cursor: pointer;
            display: inline-block;
        }

        #uploadBackgroundButton { background-image: url('symbol_background.png'); }
        #uploadForegroundButton { background-image: url('symbol_foreground.png'); }
        #selectDockButton { background-image: url('symbol_dock.png'); }
        #closePopupButton { background-image: url('symbol_close.png'); }
        #closePopupButton:active { background-image: url('symbol_close_pressed.png'); }

        .iconLabel {
            color: white;
            font-size: 14px;
            display: block;
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
        }

        #closePopupText {
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            z-index: 0;
        }

        /* Duplicate popup styles at end of body: */
        #popupOverlay.active, #popup.active {
            display: block;
        }
    </style>

    <script>
        // -- personalization state & common functions --
        let isDockBlurred = false;

        function resizeDock() {
            const flashContainer = document.getElementById("flashContainer");
            const flashHeight = flashContainer.offsetHeight;
            const height = `${flashHeight * 0.15}px`;

            ["dock", "customDock", "blurredDock"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.height = height;
            });
        }

        // Preload assets
        const assetsToPreload = [
            'bg1.jpg','bg2.jpg','bg3.jpg','bg4.jpg','bg5.jpg',
            'bg6.jpg','bg7.jpg','bg8.jpg','bg9.jpg','bg10.jpg',
            'bg11.jpg','bg12.jpg','bg13.jpg','bg14.jpg','bg15.jpg',
            'bg16.jpg','bg17.jpg','bg18.jpg','bg19.jpg','bg20.jpg',
            'restart.png','restart_pressed.png','shuffle.png','shuffle_pressed.png',
            'enable_sugardrops.png','enable_sugardrops_pressed.png',
            'editor.png','editor_pressed.png','get_basilisk.png','get_basilisk_pressed.png',
            'discord.png','discord_pressed.png','sitebackground.png','sitebackground_pressed.png',
            'symbol_background.png','symbol_foreground.png','symbol_dock.png',
            'symbol_close.png','symbol_close_pressed.png','press.mp3','dock.png','ccgame_levelLoader.swf'
        ];

        function preloadAssets(assets) {
            assets.forEach(asset => {
                const img = new Image();
                img.src = asset;
            });
            assets.filter(a => a.endsWith('.mp3')).forEach(asset => {
                const audio = new Audio(asset);
                audio.load();
            });
        }

        function getRandomBackground() {
            const num = Math.floor(Math.random()*20)+1;
            return `bg${num}.jpg`;
        }

        function playSound() {
            const audio = new Audio('press.mp3');
            audio.play();
        }

        function getUrlsFromFile() {
            return fetch('urls.txt')
                .then(r => r.text())
                .then(t => t.split('\n').map(u => u.trim()).filter(u => u));
        }

        function enableSugarDrops() {
            playSound();
            let u = window.location.href;
            if (!u.includes('/sugardropindex.html')) {
                window.location.href = u.replace('?', 'sugardropindex.html?');
            }
        }

        function redirectToEditor() {
            playSound();
            window.location.href = 'https://lisasimpson189.github.io/CandyCrushSagaEditorFExtended/';
        }

        function redirectToBasilisk() {
            playSound();
            window.location.href = "https://drive.google.com/file/d/103KpMdMcqXbQgTFHCotAba4896h4NAKd/view?usp=sharing";
        }

        function redirectToDiscord() {
            playSound();
            window.location.href = "https://discord.gg/YXZDezFfTf";
        }

        function openPopup() {
            document.getElementById("popupOverlay").classList.add('active');
            const pop = document.getElementById("popup");
            pop.classList.add('active');
            setTimeout(() => pop.style.transform = 'translate(-50%, 0)', 10);
        }

        function closePopup() {
            const pop = document.getElementById("popup");
            pop.style.transform = 'translate(-50%, -100%)';
            setTimeout(() => {
                document.getElementById("popupOverlay").classList.remove('active');
                pop.classList.remove('active');
            }, 300);
        }

        // Called repeatedly until SWF exposes getLevelCode
        function callGetLevelCode() {
            const flash = document.getElementById("flash");
            try {
                if (flash && typeof flash.getLevelCode === "function") {
                    flash.getLevelCode(decodeURIComponent(location.search.split("levelCode=")[1].split("&")[0]));
                } else {
                    throw 'no fn';
                }
            } catch {
                setTimeout(callGetLevelCode, 100);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            preloadAssets(assetsToPreload);
            document.body.style.backgroundImage = `url('${getRandomBackground()}')`;

            // If user passed levelCode with sugarTrack, auto-enable
            const lvl = new URLSearchParams(window.location.search).get('levelCode');
            if (lvl && decodeURIComponent(lvl).includes('"enableSugarTrack":true')) {
                enableSugarDrops();
            }

            // Core buttons
            document.getElementById("restartButton").addEventListener("click", () => {
                playSound();
                setTimeout(callGetLevelCode, 100);
            });
            document.getElementById("shuffleButton").addEventListener("click", () => {
                playSound();
                getUrlsFromFile()
                    .then(urls => {
                        if (urls.length) window.location.href = urls[Math.floor(Math.random()*urls.length)];
                        else console.error('No URLs');
                    })
                    .catch(e => console.error(e));
            });
            document.getElementById("sugarDropButton").addEventListener("click", enableSugarDrops);
            document.getElementById("editorButton").addEventListener("click", redirectToEditor);
            document.getElementById("basiliskButton").addEventListener("click", redirectToBasilisk);
            document.getElementById("discordButton").addEventListener("click", redirectToDiscord);

            // Popup handlers
            document.getElementById("uploadButton").addEventListener("click", openPopup);
            document.getElementById("closePopupButton").addEventListener("click", closePopup);

            // Background upload
            document.getElementById("uploadBackgroundButton").addEventListener("click", () => {
                const fi = document.getElementById("fileInput");
                fi.accept = "image/png, image/jpeg, image/gif, image/bmp, image/webp, video/mp4, video/webm, video/ogg";
                fi.click();
                fi.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const upB = document.getElementById("uploadedBackground");
                        const blB = document.getElementById("blurredBackground");
                        const vid = document.getElementById("backgroundVideo");
                        if (file.type.startsWith('video/')) {
                            vid.src = ev.target.result;
                            vid.style.display = 'block';
                            upB.style.display = blB.style.display = 'none';
                            vid.play();
                        } else {
                            upB.src = blB.src = ev.target.result;
                            upB.style.display = blB.style.display = 'block';
                            vid.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                };
            });

            // Foreground upload
            document.getElementById("uploadForegroundButton").addEventListener("click", () => {
                const fi = document.getElementById("fileInput");
                fi.accept = "image/png, image/jpeg, image/gif, image/bmp, image/webp, video/mp4, video/webm, video/ogg";
                fi.click();
                fi.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const fgVid = document.getElementById("foregroundVideo");
                        if (file.type.startsWith('video/')) {
                            fgVid.src = ev.target.result;
                            fgVid.style.display = 'block';
                            document.body.style.backgroundImage = 'none';
                            fgVid.play();
                        } else {
                            document.body.style.backgroundImage = `url('${ev.target.result}')`;
                            fgVid.style.display = 'none';
                        }
                    };
                    reader.readAsDataURL(file);
                };
            });

            // Dock selection
            document.getElementById("selectDockButton").addEventListener("click", () => {
                const fi = document.getElementById("fileInput");
                fi.accept = "image/png, image/jpeg, image/gif, image/bmp, image/webp";
                fi.click();
                fi.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const cd = document.getElementById("customDock");
                        const bd = document.getElementById("blurredDock");
                        cd.src = bd.src = ev.target.result;
                        document.getElementById("dock").style.display = "none";
                        if (isDockBlurred) {
                            cd.style.display = "none";
                            bd.style.display = "block";
                        } else {
                            cd.style.display = "block";
                            bd.style.display = "none";
                        }
                        resizeDock();
                    };
                    reader.readAsDataURL(file);
                };
            });

            // Blur toggle
            document.getElementById("dockBlurToggle").addEventListener("change", function() {
                isDockBlurred = this.checked;
                const cd = document.getElementById("customDock");
                const bd = document.getElementById("blurredDock");
                if (cd.src) {
                    cd.style.display = isDockBlurred ? 'none' : 'block';
                    bd.style.display = isDockBlurred ? 'block' : 'none';
                }
            });

            // Initial sizing & SWF call
            window.addEventListener("resize", resizeDock);
            resizeDock();
            setTimeout(callGetLevelCode, 100);
        });
    </script>
</head>
<body>
    <center>
        <div id="flashContainer">
            <img id="blurredBackground" alt="Blurred Background">
            <img id="uploadedBackground" alt="Uploaded Background">
            <video id="backgroundVideo" muted loop></video>
            <object id="flash" type="application/x-shockwave-flash"
                    data="ccgame_levelLoader.swf" width="755" height="600">
                <param name="movie" value="ccgame_levelLoader.swf" />
                <param name="wmode" value="transparent" />
                <param name="allowScriptAccess" value="always" />
                <param name="allowFullScreen" value="true" />
            </object>
        </div>
    </center>

    <video id="foregroundVideo" muted loop></video>
    <img id="dock" src="dock.png" alt="Dock Image">
    <img id="customDock" src="dock.png" alt="Custom Dock"
    style="display: none; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1;">

    <img id="blurredDock" alt="Blurred Custom Dock"
         style="display: none; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; filter: blur(8px);">

    <div id="buttonContainer">
        <button id="restartButton"><span class="tooltip">Refresh</span></button>
        <button id="shuffleButton"><span class="tooltip">Shuffle</span></button>
        <button id="sugarDropButton"><span class="tooltip">Enable Sugar Drops</span></button>
        <button id="editorButton"><span class="tooltip">Editor</span></button>
        <button id="basiliskButton"><span class="tooltip">Get a Flash Enabled browser</span></button>
        <button id="discordButton"><span class="tooltip">CCSFE Discord Server</span></button>
        <input type="file" id="fileInput" style="display: none;">
        <button id="uploadButton"><span class="tooltip">Personalization</span></button>
    </div>

    <div id="popupOverlay"></div>
    <div id="popup">
        <h3 style="margin: 0;">Personalization</h3>
        <div style="display: flex; justify-content: center;">
            <div style="position: relative;">
                <button id="uploadBackgroundButton"></button>
                <span class="iconLabel">Background</span>
            </div>
            <div style="margin-left: 10px; position: relative;">
                <button id="uploadForegroundButton"></button>
                <span class="iconLabel">Foreground</span>
            </div>
            <div style="margin-left: 10px; position: relative;">
                <button id="selectDockButton"></button>
                <span class="iconLabel">Docks</span>
            </div>
            <div style="margin-left: 10px; display: flex; align-items: center;">
                <input type="checkbox" id="dockBlurToggle" style="margin-right: 5px;">
                <label for="dockBlurToggle" style="color: white;">Blur Dock</label>
            </div>
            <div style="margin-left: 10px; position: relative;">
                <button id="closePopupButton"></button>
                <span class="iconLabel" id="closePopupText">Close</span>
            </div>
        </div>
    </div>
    <script>
        function matchDockSize() {
            const dock = document.getElementById("dock");
            const customDock = document.getElementById("customDock");
            const blurredDock = document.getElementById("blurredDock");

            if (dock.complete) {
                const { width, height } = dock.getBoundingClientRect();
                [customDock, blurredDock].forEach(el => {
                    if (el) {
                        el.style.width = `${width}px`;
                        el.style.height = `${height}px`;
                    }
                });
            } else {
                dock.onload = matchDockSize;
            }
        }

        window.addEventListener("resize", () => {
            resizeDock();
            matchDockSize();
        });

        window.addEventListener("load", () => {
            resizeDock();
            matchDockSize();
        });
    </script>
</body>
</html>

